<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ¨ 2026 æ–°å¹´é­”æ³• âœ¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: "Microsoft YaHei", sans-serif; touch-action: none; }
        
        /* è§†é¢‘å±‚ï¼šä½¿ç”¨ object-fit: cover å¡«æ»¡æ‰‹æœºå±å¹• */
        #input_video { 
            position: absolute; width: 100%; height: 100%; object-fit: cover; 
            transform: scaleX(-1); opacity: 0.6; z-index: 1; 
        }
        #output_canvas { position: absolute; width: 100%; height: 100%; z-index: 2; }
        
        #ui-layer {
            position: absolute; width: 100%; height: 100%; z-index: 3; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 20px; /* æ‰‹æœºåº•éƒ¨ç•™ç©º */
        }

        .scene-title {
            color: rgba(255,255,255,0.95); font-size: 1.8rem; font-weight: bold; /* æ‰‹æœºå­—ä½“è°ƒå° */
            text-shadow: 0 0 10px rgba(0,255,255,0.8);
            transition: all 0.5s; opacity: 0; transform: translateY(20px);
            text-align: center; margin-bottom: 20px; width: 90%;
        }
        .scene-title.active { opacity: 1; transform: translateY(0); }
        
        /* å¼•å¯¼æ ï¼šç¼©å°é—´è·é€‚åº”æ‰‹æœº */
        .guide-bar {
            display: flex; gap: 10px; background: rgba(0,0,0,0.6); 
            padding: 10px 15px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2);
            transition: opacity 0.5s; opacity: 0; margin-bottom: 30px;
        }
        .guide-item {
            font-size: 1.5rem; opacity: 0.5; transition: all 0.3s;
            position: relative; cursor: pointer;
        }
        .guide-item.active { opacity: 1; transform: scale(1.3); text-shadow: 0 0 10px #fff; }

        /* å¼€åœºæ–‡å­— */
        #intro-text {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            color: #0ff; font-size: 1.2rem; text-align: center; z-index: 4; width: 100%;
            text-shadow: 0 0 5px #0ff; font-weight: bold; letter-spacing: 1px;
            line-height: 2;
        }

        /* å¼€å§‹æŒ‰é’® (æ‰‹æœºæµè§ˆå™¨å¿…é¡»ç”¨æˆ·ç‚¹å‡»æ‰èƒ½æ’­æ”¾è§†é¢‘) */
        #start-btn {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            padding: 10px 30px; background: rgba(0, 255, 255, 0.2); border: 1px solid #0ff;
            color: #0ff; font-size: 16px; border-radius: 20px; z-index: 10; cursor: pointer;
            animation: pulse 2s infinite; display: none; /* åˆå§‹éšè— */
        }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(0, 255, 255, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(0, 255, 255, 0);} 100% {box-shadow: 0 0 0 0 rgba(0, 255, 255, 0);} }
    </style>
</head>
<body>

    <video id="input_video" autoplay playsinline webkit-playsinline></video>
    <canvas id="output_canvas"></canvas>
    
    <div id="intro-text"></div>
    <div id="start-btn">ç‚¹å‡»å¼€å¯é­”æ³•</div>
    
    <div id="ui-layer">
        <div id="title-text" class="scene-title"></div>
        <div class="guide-bar" id="guide-bar">
            <div class="guide-item" id="icon-0">âœŠ</div>
            <div class="guide-item" id="icon-1">â˜ï¸</div>
            <div class="guide-item" id="icon-2">âœŒï¸</div>
            <div class="guide-item" id="icon-3">ğŸ‘Œ</div>
            <div class="guide-item" id="icon-4">ğŸ–</div>
        </div>
    </div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const ctx = canvasElement.getContext('2d');
    const titleText = document.getElementById('title-text');
    const introDiv = document.getElementById('intro-text');
    const guideBar = document.getElementById('guide-bar');
    const startBtn = document.getElementById('start-btn');

    let width = window.innerWidth;
    let height = window.innerHeight;
    canvasElement.width = width;
    canvasElement.height = height;

    let systemState = 'WAITING_CLICK'; // æ–°çŠ¶æ€ï¼šç­‰å¾…ç”¨æˆ·ç‚¹å‡»
    let currentScene = 0; 
    let particles = [];
    let handLandmarks = null;
    let pendingScene = 0;
    let transitionTimer = 0;
    const TRANSITION_DELAY = 8; 

    // å¼€åœºæ–‡æ¡ˆ
    let introTimer = 0;
    const INTRO_LINES = [
        "æ­£åœ¨è¿æ¥ 2026...",
        "æ‹çˆ±ä¿¡å·ï¼šæ»¡æ ¼",
        "è¯†åˆ«ç›®æ ‡ï¼šæˆ‘çš„å¥³å­©",
        "åˆå§‹åŒ–å®Œæˆ"
    ];
    let currentLine = 0;
    let charIndex = 0;

    const SCENES = {
        0: { text: "ğŸ”® ç«–èµ·æ‰‹æŒ‡ å¼€å¯é­”æ³•", color: "#fff" },
        1: { text: "â˜ï¸ 2026 ä½ æ˜¯å”¯ä¸€", color: "#00ffff" },
        2: { text: "âœŒï¸ æˆ‘ä»¬å¤©ç”Ÿä¸€å¯¹", color: "#ff69b4" },
        3: { text: "ğŸ‘Œ çº¦å®šä¸‰ç”Ÿä¸‰ä¸–", color: "#7b68ee" },
        4: { text: "ğŸ– æ„¿çƒŸèŠ±å››å­£äºˆä½ ", color: "#ffd700" }
    };

    // æ‰‹æœºå¿…é¡»ç‚¹å‡»æ‰èƒ½å¼€å§‹
    introDiv.innerHTML = "ç‚¹å‡»å±å¹•<br>å¼€å¯ 2026 ä¸“å±é­”æ³•";
    startBtn.style.display = 'block';

    function startApp() {
        if(systemState !== 'WAITING_CLICK') return;
        systemState = 'INTRO_TYPING';
        startBtn.style.display = 'none';
        introDiv.innerHTML = ""; // æ¸…ç©ºæç¤º
        
        // å¯åŠ¨æ‘„åƒå¤´ (å¼ºåˆ¶å‰ç½®)
        camera.start().catch(err => {
            alert("è¯·å…è®¸æ‘„åƒå¤´æƒé™ï¼Œå¹¶ä½¿ç”¨Safariæˆ–Chromeæ‰“å¼€");
        });
        animate(); // å¼€å§‹æ¸²æŸ“å¾ªç¯
    }

    document.body.addEventListener('click', startApp);
    document.body.addEventListener('touchstart', startApp); // å…¼å®¹æ‰‹æœºè§¦æ‘¸

    // ç²’å­ç±» (å‚æ•°è°ƒæ•´é€‚åº”æ‰‹æœºæ€§èƒ½)
    class Particle {
        constructor(type, x, y) {
            this.type = type; 
            this.x = x || Math.random() * width;
            this.y = y || Math.random() * height;
            
            if (type === 'intro_gather') {
                const angle = Math.random() * Math.PI * 2;
                const r = Math.max(width, height) / 1.2;
                this.x = width/2 + Math.cos(angle) * r;
                this.y = height/2 + Math.sin(angle) * r;
                this.vx = (width/2 - this.x) * 0.05;
                this.vy = (height/2 - this.y) * 0.05;
                this.color = '#0ff';
                this.size = Math.random() * 2 + 1;
                this.life = 1;
            } else if (type === 'intro_explode') {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 15 + 5;
                this.x = width/2;
                this.y = height/2;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.color = `hsl(${Math.random()*60 + 180}, 100%, 70%)`;
                this.size = Math.random() * 4 + 2;
                this.life = 1;
                this.decay = 0.03;
            } else if (type === 1) { // åœºæ™¯1
                this.size = Math.random() * 3 + 1;
                this.life = 1;
                this.color = '#00ffff';
                this.vx = (Math.random()-0.5)*2;
                this.vy = Math.random()*5 + 5;
            } else if (type === 2) { // åœºæ™¯2
                this.size = Math.random() * 3 + 1;
                this.life = 1;
                this.color = '#ff69b4';
                this.vx = (Math.random()-0.5)*3;
                this.vy = (Math.random()-0.5)*3;
            } else if (type === 3) { // åœºæ™¯3
                this.x = width/2; this.y = height/2;
                let angle = Math.random() * Math.PI * 2;
                let speed = Math.random() * 10 + 5;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.size = Math.random()*2;
                this.life = 1;
                this.color = `hsl(${260 + Math.random()*50}, 100%, 80%)`;
            } else if (type === 4) { // åœºæ™¯4
                this.x = x; this.y = y;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 8;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.gravity = 0.15;
                this.life = 1;
                this.size = Math.random() * 3 + 2;
                this.color = `hsl(${Math.random()*360}, 100%, 60%)`;
            }
        }

        update() {
            if (this.type === 'intro_gather') {
                this.x += this.vx; this.y += this.vy;
                if (Math.abs(this.x - width/2) < 20 && Math.abs(this.y - height/2) < 20) this.life = 0;
            } else {
                this.x += this.vx; this.y += this.vy;
                if (this.gravity) this.vy += this.gravity;
                if (this.decay) this.life -= this.decay; else this.life -= 0.02;

                if (this.type === 1 && handLandmarks) {
                    let tx = handLandmarks[8].x * width;
                    let ty = handLandmarks[8].y * height;
                    this.x += (tx - this.x) * 0.1;
                    this.y += (ty - this.y) * 0.1;
                }
            }
        }

        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = this.color;
            ctx.globalAlpha = this.life;
            ctx.fill();
            ctx.globalAlpha = 1;
        }
    }

    function animate() {
        if(systemState === 'WAITING_CLICK') return;

        ctx.globalCompositeOperation = 'destination-out';
        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
        ctx.fillRect(0, 0, width, height);
        ctx.globalCompositeOperation = 'lighter'; 

        if (systemState === 'INTRO_TYPING') {
            runTypingEffect();
        } else if (systemState === 'INTRO_GATHER') {
            if (Math.random() < 0.8) particles.push(new Particle('intro_gather'));
            introTimer++;
            if (introTimer > 50) {
                systemState = 'INTRO_EXPLODE';
                for(let i=0; i<200; i++) particles.push(new Particle('intro_explode'));
            }
        } else if (systemState === 'INTRO_EXPLODE') {
            if (particles.length < 5) {
                systemState = 'GAME_ON';
                guideBar.style.opacity = 1; 
                switchScene(0);
            }
        } else if (systemState === 'GAME_ON') {
            runGameLogic();
        }

        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            particles[i].draw();
            if (particles[i].life <= 0) particles.splice(i, 1);
        }

        ctx.globalCompositeOperation = 'source-over';
        requestAnimationFrame(animate);
    }

    function runTypingEffect() {
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = '#000'; ctx.fillRect(0, 0, width, height); 
        introDiv.style.display = 'block';
        if (currentLine < INTRO_LINES.length) {
            let line = INTRO_LINES[currentLine];
            introDiv.innerHTML = INTRO_LINES.slice(0, currentLine).join('<br>') + '<br>' + line.substring(0, charIndex) + '_';
            if (Math.random() > 0.3) charIndex++; 
            if (charIndex > line.length) { currentLine++; charIndex = 0; }
        } else {
            setTimeout(() => { if(systemState === 'INTRO_TYPING') { systemState = 'INTRO_GATHER'; introTimer = 0; introDiv.style.display = 'none';} }, 500);
        }
    }

    function runGameLogic() {
        if (currentScene === 1 && handLandmarks) {
            for(let i=0; i<4; i++) particles.push(new Particle(1, handLandmarks[8].x * width, handLandmarks[8].y * height));
        } else if (currentScene === 2 && handLandmarks) {
            if(Math.random()<0.3) particles.push(new Particle(2, handLandmarks[8].x * width, handLandmarks[8].y * height));
            // è¿çº¿
            let ix = handLandmarks[8].x * width; let iy = handLandmarks[8].y * height;
            let mx = handLandmarks[12].x * width; let my = handLandmarks[12].y * height;
            ctx.strokeStyle = '#ff69b4'; ctx.lineWidth = 4; ctx.lineCap = 'round';
            ctx.shadowBlur = 10; ctx.shadowColor = '#ff69b4';
            ctx.beginPath(); ctx.moveTo(ix, iy); ctx.lineTo(mx, my); ctx.stroke();
            ctx.shadowBlur = 0;
        } else if (currentScene === 3) {
            if(Math.random()<0.5) particles.push(new Particle(3)); // å‡å°‘ç²’å­é‡é€‚åº”æ‰‹æœº
        } else if (currentScene === 4) {
             if(Math.random() < 0.1) {
                 let cx = width/2 + (Math.random()-0.5)*width*0.8;
                 let cy = height/2 + (Math.random()-0.5)*height*0.6;
                 for(let i=0; i<50; i++) particles.push(new Particle(4, cx, cy));
            }
        }
    }

    function switchScene(idx) {
        if (currentScene === idx) return;
        currentScene = idx;
        particles = []; 
        titleText.classList.remove('active');
        
        for(let i=0; i<=4; i++) {
            const icon = document.getElementById(`icon-${i}`);
            if(icon) icon.classList.remove('active');
        }
        const activeIcon = document.getElementById(`icon-${idx}`);
        if(activeIcon) activeIcon.classList.add('active');

        setTimeout(() => {
            titleText.innerText = SCENES[idx].text;
            titleText.style.textShadow = `0 0 20px ${SCENES[idx].color}`;
            titleText.classList.add('active');
        }, 100);
    }

    function onResults(results) {
        if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
            handLandmarks = null;
            if (systemState === 'GAME_ON') handleGesture(0);
            return;
        }

        const landmarks = results.multiHandLandmarks[0];
        handLandmarks = landmarks.map(lm => ({ x: 1 - lm.x, y: lm.y }));
        
        const tips = [8, 12, 16, 20]; 
        const pips = [6, 10, 14, 18]; 
        let fingersUp = [];
        tips.forEach((tip, i) => {
            fingersUp.push(landmarks[tip].y < landmarks[pips[i]].y);
        });

        let cx = landmarks[9].x; 
        let thumbOut = Math.abs(landmarks[4].x - cx) > 0.08; // æ‰‹æœºä¸Šé˜ˆå€¼å¾®è°ƒ

        let count = fingersUp.filter(f => f).length;
        if (thumbOut) count++;

        let target = 0;
        // OK æ‰‹åŠ¿æ£€æµ‹
        let distThumbIndex = Math.hypot(landmarks[4].x - landmarks[8].x, landmarks[4].y - landmarks[8].y);
        let isOkGesture = (distThumbIndex < 0.05) && fingersUp[1];

        if (count === 0 || count === 1 && !fingersUp[0]) target = 0; 
        else if (isOkGesture) target = 3; 
        else if (count === 1) target = 1; 
        else if (count === 2) target = 2; 
        else if (count === 3) target = 3; 
        else if (count >= 4) target = 4;

        handleGesture(target);
    }

    function handleGesture(target) {
        if (target === pendingScene) {
            transitionTimer++;
            if (transitionTimer > TRANSITION_DELAY && systemState === 'GAME_ON') {
                switchScene(target);
                transitionTimer = 0;
            }
        } else {
            pendingScene = target;
            transitionTimer = 0;
        }
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5}); // æ‰‹æœºä½¿ç”¨è½»é‡æ¨¡å‹
    hands.onResults(onResults);

    // æ‰‹æœºå¿…é¡»æ‰‹åŠ¨è§¦å‘ Video
    const camera = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 1280, height: 720,
        facingMode: "user" // é‡è¦ï¼šå¼ºåˆ¶å‰ç½®æ‘„åƒå¤´
    });

    window.addEventListener('resize', () => {
        width = window.innerWidth; height = window.innerHeight;
        canvasElement.width = width; canvasElement.height = height;
    });
</script>
</body>
</html>